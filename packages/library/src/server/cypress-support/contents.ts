import { format, resolveConfig } from "prettier"
import { fileURLToPath } from "url"

const __filename = fileURLToPath(import.meta.url)

export async function createCypressSupportFileContents(): Promise<string> {
  // this is the interface of tui-sandbox as far as cypress in the user's
  // application is concerned
  let text = ` 
/// <reference types="cypress" />
//
// This file is autogenerated by tui-sandbox. Do not edit it directly.
//
import type { OverrideProperties } from "type-fest"
import type { StartNeovimGenericArguments } from "@tui-sandbox/library/dist/src/server/types"
import type { MyTestDirectory, MyTestDirectoryFile } from "../../MyTestDirectory"

export type NeovimContext = {
  contents: MyTestDirectory
  rootPathAbsolute: string
}

declare global {
  interface Window {
    startNeovim(startArguments?: MyStartNeovimServerArguments): Promise<NeovimContext>
  }
}

type MyStartNeovimServerArguments = OverrideProperties<
  StartNeovimGenericArguments,
  {
    filename?: MyTestDirectoryFile | { openInVerticalSplits: MyTestDirectoryFile[] }
    // NOTE: right now you need to make sure the config-modifications directory exists in your test directory
    startupScriptModifications?: Array<keyof MyTestDirectory["config-modifications"]["contents"]>
  }
>

Cypress.Commands.add("startNeovim", (startArguments?: MyStartNeovimServerArguments) => {
  cy.window().then(async win => {
    return await win.startNeovim(startArguments)
  })
})

Cypress.Commands.add("typeIntoTerminal", (text: string, options?: Partial<Cypress.TypeOptions>) => {
  // the syntax for keys is described here:
  // https://docs.cypress.io/api/commands/type
  cy.get("textarea").focus().type(text, options)
})

declare global {
  namespace Cypress {
    interface Chainable {
      startNeovim(args?: MyStartNeovimServerArguments): Chainable<NeovimContext>
      typeIntoTerminal(text: string, options?: Partial<Cypress.TypeOptions>): Chainable<void>
    }
  }
}
`

  const options = await resolveConfig(__filename)
  text = await format(text, { ...options, parser: "typescript" })

  return text
}
